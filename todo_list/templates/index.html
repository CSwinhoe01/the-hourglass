{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container">

  <!-- Title + Auth -->
  <div class="row align-items-center g-2 mt-3 mb-2">
    <div class="col-6">
      <h1 class="h1 mb-0">The Hourglass</h1>
    </div>
    <div class="col-6 text-end">
      {% if user.is_authenticated %}
        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#logoutModal">
          Logout
        </button>
      {% else %}
        <!-- open LOGIN modal (changed target) -->
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">
          Login
        </button>
      {% endif %}
    </div>
  </div>

  {% if not user.is_authenticated %}
  <div class="text-center my-3">
    <!-- open LOGIN modal (changed target) -->
    <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#loginModal">
      Login to manage your tasks
    </button>
  </div>
  {% endif %}

  <!-- Category (left) + Search (right) -->
  <div class="row align-items-end g-2 mb-3">
    <div class="col-6">
      <form method="get" class="d-flex gap-2">
        <div class="flex-grow-1">
          <label for="category" class="form-label mb-1">Category</label>
          <select id="category" name="category" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="" {% if not selected_category %}selected{% endif %}>All</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if selected_category|stringformat:'s' == cat.id|stringformat:'s' %}selected{% endif %}>
                {{ cat.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <input type="hidden" name="q" value="{{ q|default:'' }}">
        <input type="hidden" name="sort" value="{{ sort_by|default:'due_date' }}">
      </form>
    </div>

    <div class="col-6">
      <form method="get" class="d-flex justify-content-end gap-2">
        <div class="flex-grow-1" style="max-width: 320px;">
          <label for="q" class="form-label mb-1">Search</label>
          <input id="q" name="q" class="form-control form-control-sm" type="search"
                 placeholder="Search tasks by title" value="{{ q|default:'' }}">
        </div>
        <input type="hidden" name="category" value="{{ selected_category|default:'' }}">
        <input type="hidden" name="sort" value="{{ sort_by|default:'due_date' }}">
        <button class="btn btn-sm btn-primary align-self-end" type="submit">Search</button>
      </form>
    </div>
  </div>

  <!-- To‑Do (sticky notes) + Completed (sticky notes) -->
  <div class="row g-4 equalize">
    <!-- To‑Do -->
    <div class="col-12 col-xl-6 d-flex">
      <div class="panel flex-fill d-flex flex-column">
        <h2 class="notepad-title">To‑Do</h2>

        <div class="sticky-board">
          {% for task in tasks %}
          {% if task.status != 'completed' %}
            <article class="sticky-note">
              <span class="pin" aria-hidden="true"></span>
              <h5 class="note-title">{{ task.title }}</h5>
              <p class="note-meta">
                {{ task.due_date|date:"M j, Y H:i" }}
                {% if task.category %} • {{ task.category.name }}{% endif %}
                {% if task.status %} • {{ task.status }}{% endif %}
              </p>
              <div class="note-actions">
                {% if user.is_authenticated %}
                  <a href="{% url 'task_edit' task.pk %}" class="btn btn-sm btn-primary">Edit</a>
                  <a href="{% url 'task_delete' task.pk %}" class="btn btn-sm btn-danger">Delete</a>
                  <form action="{% url 'task_complete' task.pk %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success">Complete</button>
                  </form>
                {% else %}
                  <!-- Block actions when logged out -->
                  <button type="button" class="btn btn-sm btn-primary require-auth">Edit</button>
                  <button type="button" class="btn btn-sm btn-danger require-auth">Delete</button>
                  <button type="button" class="btn btn-sm btn-success require-auth">Complete</button>
                {% endif %}
              </div>
            </article>
          {% endif %}
          {% endfor %}
        </div>

        <!-- Create icon (blocked when logged out) -->
        <div class="text-center mt-3">
          {% if user.is_authenticated %}
            <a href="{% url 'task_create' %}" aria-label="Create task" class="d-inline-block">
              <img src="{% static 'image/Add_icon.webp' %}" alt="Create Task"
                   class="img-fluid mx-auto d-block" style="max-width:64px;height:auto;">
            </a>
          {% else %}
            <a href="#" class="d-inline-block require-auth" aria-label="Login required">
              <img src="{% static 'image/Add_icon.webp' %}" alt="Create Task"
                   class="img-fluid mx-auto d-block" style="max-width:64px;height:auto;">
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Completed -->
    <div class="col-12 col-xl-6 d-flex">
      <div class="panel flex-fill d-flex flex-column">
        <h2 class="notepad-title">Completed</h2>
        <div class="sticky-board">
          {% for task in tasks %}
          {% if task.status == 'completed' %}
            <article class="sticky-note">
              <span class="pin" aria-hidden="true"></span>
              <h5 class="note-title">{{ task.title }}</h5>
              <p class="note-meta">
                {{ task.due_date|date:"M j, Y H:i" }}
                {% if task.category %} • {{ task.category.name }}{% endif %}
              </p>
              <div class="note-actions">
                {% if user.is_authenticated %}
                  <a href="{% url 'task_edit' task.pk %}" class="btn btn-sm btn-primary">Edit</a>
                  <a href="{% url 'task_delete' task.pk %}" class="btn btn-sm btn-danger">Delete</a>
                {% else %}
                  <button type="button" class="btn btn-sm btn-primary require-auth">Edit</button>
                  <button type="button" class="btn btn-sm btn-danger require-auth">Delete</button>
                {% endif %}
              </div>
            </article>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL (renders AllAuth LoginForm) -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form action="{% url 'account_login' %}" method="post" novalidate>
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Login</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {% if login_form.non_field_errors %}
              <div class="alert alert-danger py-2 mb-2">{{ login_form.non_field_errors }}</div>
            {% endif %}
            {% for field in login_form.visible_fields %}
              <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}<div class="form-text">{{ field.help_text|safe }}</div>{% endif %}
                {% for err in field.errors %}<div class="invalid-feedback d-block">{{ err }}</div>{% endfor %}
              </div>
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Login</button>
            <!-- This button opens the separate Signup modal -->
            <button type="button" id="open-signup" class="btn btn-outline-primary ms-auto" aria-controls="signup">
              Sign up
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- LOGOUT MODAL (posts to AllAuth logout) -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <form action="{% url 'account_logout' %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.path }}">
          <div class="modal-header">
            <h5 class="modal-title" id="logoutModalLabel">Logout</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">Are you sure you want to log out?</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Logout</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SIGNUP MODAL (renders AllAuth SignupForm) -->
  <div class="modal fade" id="signup" tabindex="-1" aria-labelledby="signupLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form action="{% url 'account_signup' %}" method="post" novalidate>
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <div class="modal-header">
            <h5 class="modal-title" id="signupLabel">Create your account</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {% if signup_form.non_field_errors %}
              <div class="alert alert-danger py-2 mb-2">{{ signup_form.non_field_errors }}</div>
            {% endif %}
            {% for field in signup_form.visible_fields %}
              <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}<div class="form-text">{{ field.help_text|safe }}</div>{% endif %}
                {% for err in field.errors %}<div class="invalid-feedback d-block">{{ err }}</div>{% endfor %}
              </div>
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Sign up</button>
            <button type="button" class="btn btn-link ms-auto" id="open-login">Already have an account? Log in</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast (top-right) -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="authToast" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          Please login to manage your tasks.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const loginEl = document.getElementById('loginModal');
  const signupEl = document.getElementById('signup');
  const btn = document.getElementById('open-signup');

  if (btn && loginEl && signupEl) {
    btn.addEventListener('click', function (e) {
      e.preventDefault();

      // If login isn't open, just show signup.
      const loginInstance = bootstrap.Modal.getOrCreateInstance(loginEl);
      const isOpen = loginEl.classList.contains('show');

      if (!isOpen) {
        bootstrap.Modal.getOrCreateInstance(signupEl).show();
        return;
      }

      // Attach listener BEFORE hiding to avoid race.
      const onHidden = () => {
        loginEl.removeEventListener('hidden.bs.modal', onHidden);
        bootstrap.Modal.getOrCreateInstance(signupEl).show();
      };
      loginEl.addEventListener('hidden.bs.modal', onHidden, { once: true });
      loginInstance.hide();
    });
  }

  // Autofocus first field when either modal is shown
  document.addEventListener('shown.bs.modal', function (e) {
    if (e.target.id === 'loginModal' || e.target.id === 'signup') {
      const input = e.target.querySelector('input, select, textarea');
      if (input) input.focus();
    }
  });
});

  // Show toast + open LOGIN modal when a protected control is used
  (function () {
    const toastEl = document.getElementById('authToast');
    const toast = toastEl ? new bootstrap.Toast(toastEl) : null;
    function promptLogin(e) {
      e.preventDefault();
      if (toast) toast.show();
      const modalEl = document.getElementById('loginModal');
      if (modalEl) bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }
    document.querySelectorAll('.require-auth').forEach(el => el.addEventListener('click', promptLogin));
  })();

  // Switch modals: Login -> Signup
  document.getElementById('open-signup')?.addEventListener('click', function (e) {
    e.preventDefault();
    const fromEl = document.getElementById('loginModal');
    const toEl = document.getElementById('signup');
    if (!fromEl || !toEl) return;
    const onHidden = () => {
      fromEl.removeEventListener('hidden.bs.modal', onHidden);
      bootstrap.Modal.getOrCreateInstance(toEl).show();
    };
    fromEl.addEventListener('hidden.bs.modal', onHidden, { once: true });
    bootstrap.Modal.getOrCreateInstance(fromEl).hide();
  });

  // Switch modals: Signup -> Login
  document.getElementById('open-login')?.addEventListener('click', function (e) {
    e.preventDefault();
    const fromEl = document.getElementById('signup');
    const toEl = document.getElementById('loginModal');
    if (!fromEl || !toEl) return;
    const onHidden = () => {
      fromEl.removeEventListener('hidden.bs.modal', onHidden);
      bootstrap.Modal.getOrCreateInstance(toEl).show();
    };
    fromEl.addEventListener('hidden.bs.modal', onHidden, { once: true });
    bootstrap.Modal.getOrCreateInstance(fromEl).hide();
  });
</script>
{% endblock %}