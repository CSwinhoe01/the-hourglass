{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container">

  <!-- Title (left) + Login/Logout (right) ALWAYS inline -->
  <div class="row align-items-center g-2 mt-3 mb-2">
    <div class="col-6">
      <h1 class="h1 mb-0"><i class="nf nf-oct-hourglass"></i> The Hourglass</h1>
    </div>
    <div class="col-6 text-end">
      {% if user.is_authenticated %}
        <a href="{% url 'account_logout' %}" class="btn btn-sm btn-danger">Logout</a>
      {% else %}
        <a href="{% url 'account_login' %}" class="btn btn-sm btn-primary">Login</a>
      {% endif %}
    </div>
  </div>

  <!-- Category (left) + Search (right) ALWAYS inline -->
  <div class="row align-items-end g-2 mb-3">
    <!-- Category filter -->
    <div class="col-6">
      <form method="get" id="category-form" class="d-flex gap-2">
        <div class="flex-grow-1">
          <label for="category" class="form-label mb-1">Category</label>
          <select id="category" name="category" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="" {% if not selected_category %}selected{% endif %}>All</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}"
                {% if selected_category|stringformat:'s' == cat.id|stringformat:'s' %}selected{% endif %}>
                {{ cat.name }}
              </option>
            {% empty %}
              <option disabled>(No categories)</option>
            {% endfor %}
          </select>
        </div>
        <!-- preserve search + sort -->
        <input type="hidden" name="q" value="{{ q|default:'' }}">
        <input type="hidden" name="sort" value="{{ sort_by }}">
        <noscript><button class="btn btn-sm btn-primary" type="submit">Apply</button></noscript>
      </form>
    </div>

    <!-- Search -->
    <div class="col-6">
      <form method="get" class="d-flex justify-content-end gap-2">
        <div class="flex-grow-1" style="max-width: 320px;">
          <label for="q" class="form-label mb-1">Search</label>
          <input id="q" name="q" class="form-control form-control-sm" type="search"
                 placeholder="Search tasks by title" value="{{ q|default:'' }}">
        </div>
        <!-- preserve category + sort -->
        <input type="hidden" name="category" value="{{ selected_category|default:'' }}">
        <input type="hidden" name="sort" value="{{ sort_by }}">
        <button class="btn btn-sm btn-primary align-self-end" type="submit">Search</button>
      </form>
    </div>
  </div>

  <!-- Tables: side-by-side >=992px, stacked below -->
  <div class="row g-4 equalize">
    <!-- To-Do -->
    <div class="col-12 col-lg-6 d-flex">
      <div class="panel flex-fill d-flex flex-column">
        <h2><i class="nf nf-fa-pencil"></i> To-Do</h2>
        <div class="table-responsive flex-grow-1">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>
                  <a href="?sort=due_date{% if selected_category %}&category={{ selected_category }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">
                    Due Date
                  </a>
                </th>
                <th>
                  <a href="?sort=title{% if selected_category %}&category={{ selected_category }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">
                    Title
                  </a>
                </th>
                <th>
                  <a href="?sort=status{% if selected_category %}&category={{ selected_category }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">
                    Status
                  </a>
                </th>
                <th>Category</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for task in tasks %}
              {% if task.status != 'completed' %}
              <tr>
                <td>{{ task.due_date }}</td>
                <td>{{ task.title }}</td>
                <td>{{ task.status }}</td>
                <td>{{ task.category.name }}</td>
                <td class="text-nowrap">
                  <a href="{% url 'task_edit' task.pk %}" class="btn btn-sm btn-primary">Edit</a>
                  <a href="{% url 'task_delete' task.pk %}" class="btn btn-sm btn-danger">Delete</a>
                  <form action="{% url 'task_complete' task.pk %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success">Complete</button>
                  </form>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Centered Add icon under To-Do -->
        <div class="text-center mt-3">
          <a href="{% url 'task_create' %}" aria-label="Create task" class="d-inline-block">
            <img src="{% static 'Add_icon.webp' %}" alt="Create Task" class="img-fluid mx-auto d-block" style="max-width:64px;height:auto;">
          </a>
        </div>
      </div>
    </div>

    <!-- Completed -->
    <div class="col-12 col-lg-6 d-flex">
      <div class="panel flex-fill d-flex flex-column">
        <h2><i class="nf nf-fa-circle_check"></i> Completed</h2>
        <div class="table-responsive flex-grow-1">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Due Date</th>
                <th>Title</th>
                <th>Status</th>
                <th>Category</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for task in tasks %}
              {% if task.status == 'completed' %}
              <tr>
                <td>{{ task.due_date }}</td>
                <td>{{ task.title }}</td>
                <td>{{ task.status }}</td>
                <td>{{ task.category.name }}</td>
                <td class="text-nowrap">
                  <a href="{% url 'task_edit' task.pk %}" class="btn btn-sm btn-primary">Edit</a>
                  <a href="{% url 'task_delete' task.pk %}" class="btn btn-sm btn-danger">Delete</a>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Equal heights only on >=992px; stack below that */
  @media (min-width: 992px) {
    .equalize > [class*="col-"] { display: flex; }
    .equalize .panel { display: flex; flex-direction: column; width: 100%; }
    .equalize .panel .table-responsive { flex: 1 1 auto; }
  }
</style>
{% endblock %}